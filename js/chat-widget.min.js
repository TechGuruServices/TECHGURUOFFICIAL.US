document.addEventListener('DOMContentLoaded',()=>{const chatToggle=document.getElementById('chat-toggle');const chatWindow=document.getElementById('chat-window');const chatClose=document.getElementById('chat-close');const chatClear=document.getElementById('chat-clear');const chatForm=document.getElementById('chat-form');const chatInput=document.getElementById('chat-input');const chatMessages=document.getElementById('chat-messages');const chatHeader=document.querySelector('.chat-header');const chatContainer=document.querySelector('.chat-widget-container');const chatFloatingCtas=document.getElementById('chat-floating-ctas');const chatUploadBtn=document.getElementById('chat-upload-btn');const chatFileInput=document.getElementById('chat-file-input');const chatFilePreview=document.getElementById('chat-file-preview');const chatVoiceBtn=document.getElementById('chat-voice-btn');const chatSendBtn=document.getElementById('chat-send-btn');const chatCharCount=document.getElementById('chat-char-count');const chatSuggestions=document.getElementById('chat-suggestions');const chatTypingIndicator=document.getElementById('chat-typing');const API_ENDPOINT='/api/chat';const MAX_CHARS=500;let isOpen=false;let isLoading=false;let hasShownProactivePrompt=sessionStorage.getItem('chatPromptShown');let ctasVisible=false;let ctaHideTimeout=null;let messageCount=0;let hasOfferedLeadCapture=false;let uploadedFiles=[];let isRecording=false;let mediaRecorder=null;let audioChunks=[];let recordingStartTime=null;let recordingTimer=null;let isDragging=false;let dragOffsetX=0;let dragOffsetY=0;let dragStartX=0;let dragStartY=0;let hasMoved=false;let isResizing=false;let resizeDirection=null;let resizeStartX=0;let resizeStartY=0;let resizeStartWidth=0;let resizeStartHeight=0;let resizeStartLeft=0;let resizeStartTop=0;let resizeStartRight=0;let resizeStartBottom=0;const MIN_WIDTH=280;const MIN_HEIGHT=400;const MAX_WIDTH=600;const getMaxHeight=()=>Math.min(800,window.innerHeight-140);function showFloatingCtas(){if(chatFloatingCtas&&!isOpen){chatFloatingCtas.classList.add('visible');ctasVisible=true;if(ctaHideTimeout){clearTimeout(ctaHideTimeout);ctaHideTimeout=null;}}}
function hideFloatingCtas(){if(chatFloatingCtas){ctaHideTimeout=setTimeout(()=>{chatFloatingCtas.classList.remove('visible');ctasVisible=false;},300);}}
if(chatContainer&&chatFloatingCtas){chatContainer.addEventListener('mouseenter',showFloatingCtas);chatContainer.addEventListener('mouseleave',hideFloatingCtas);chatFloatingCtas.addEventListener('mouseenter',()=>{if(ctaHideTimeout){clearTimeout(ctaHideTimeout);ctaHideTimeout=null;}});chatFloatingCtas.addEventListener('mouseleave',hideFloatingCtas);chatToggle.addEventListener('touchstart',()=>{if(!ctasVisible&&!isOpen){showFloatingCtas();setTimeout(()=>{if(!isOpen)hideFloatingCtas();},3000);}},{passive:true});}
if(chatUploadBtn&&chatFileInput&&chatFilePreview){chatUploadBtn.addEventListener('click',()=>{chatFileInput.click();});chatFileInput.addEventListener('change',(e)=>{const files=Array.from(e.target.files);files.forEach(file=>{if(file.size>5*1024*1024){alert(`File"${file.name}"is too large.Maximum size is 5MB.`);return;}
if(!uploadedFiles.find(f=>f.name===file.name&&f.size===file.size)){uploadedFiles.push(file);}});updateFilePreview();chatFileInput.value='';});}
function updateFilePreview(){if(!chatFilePreview)return;chatFilePreview.innerHTML='';if(uploadedFiles.length===0){chatFilePreview.classList.remove('has-files');return;}
chatFilePreview.classList.add('has-files');uploadedFiles.forEach((file,index)=>{const fileItem=document.createElement('div');fileItem.className='file-preview-item';const icon=getFileIcon(file.type);fileItem.innerHTML=`<span class="file-icon">${icon}</span><span class="file-name"title="${file.name}">${file.name}</span><button class="file-remove"data-index="${index}"aria-label="Remove file">&times;</button>`;chatFilePreview.appendChild(fileItem);});chatFilePreview.querySelectorAll('.file-remove').forEach(btn=>{btn.addEventListener('click',(e)=>{const index=parseInt(e.target.dataset.index);uploadedFiles.splice(index,1);updateFilePreview();});});}
function getFileIcon(mimeType){if(mimeType.startsWith('image/'))return'ðŸ–¼ï¸';if(mimeType.includes('pdf'))return'ðŸ“„';if(mimeType.includes('word')||mimeType.includes('document'))return'ðŸ“';if(mimeType.includes('text'))return'ðŸ“ƒ';return'ðŸ“Ž';}
if(chatVoiceBtn){chatVoiceBtn.addEventListener('click',async()=>{if(isRecording){stopVoiceRecording();}else{startVoiceRecording();}});}
async function startVoiceRecording(){try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(stream);audioChunks=[];mediaRecorder.ondataavailable=(e)=>{audioChunks.push(e.data);};mediaRecorder.onstop=async()=>{stream.getTracks().forEach(track=>track.stop());const audioBlob=new Blob(audioChunks,{type:'audio/webm'});addMessage("ðŸŽ¤ Voice message recorded (speech-to-text integration pending)",'user');};mediaRecorder.start();isRecording=true;chatVoiceBtn.classList.add('recording');chatVoiceBtn.title='Stop recording';recordingStartTime=Date.now();}catch(err){console.error('Voice recording error:',err);alert('Could not access microphone. Please check permissions.');}}
function stopVoiceRecording(){if(mediaRecorder&&isRecording){mediaRecorder.stop();isRecording=false;chatVoiceBtn.classList.remove('recording');chatVoiceBtn.title='Voice input';}}
if(!hasShownProactivePrompt){setTimeout(()=>{if(!isOpen&&!hasShownProactivePrompt){showProactivePrompt();}},30000);}
function showProactivePrompt(){const promptBubble=document.createElement('div');promptBubble.className='chat-proactive-prompt';promptBubble.innerHTML=`<button class="prompt-close"aria-label="Close">&times;</button><p>ðŸ‘‹ Have questions about automation?</p><span>Let's chatâ€”I'm here to help.</span>`;promptBubble.style.cssText=`position:absolute;bottom:80px;right:0;background:linear-gradient(135deg,rgba(74,108,247,0.95),rgba(162,116,255,0.95));color:white;padding:1rem 1.25rem;border-radius:12px 12px 0 12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);max-width:220px;animation:promptSlideIn 0.4s ease;cursor:pointer;z-index:1000;`;if(!document.getElementById('proactive-prompt-styles')){const styleSheet=document.createElement('style');styleSheet.id='proactive-prompt-styles';styleSheet.textContent=`@keyframes promptSlideIn{from{opacity:0;transform:translateY(20px)scale(0.9);}
to{opacity:1;transform:translateY(0)scale(1);}}.chat-proactive-prompt p{margin:0 0 0.25rem 0;font-weight:600;font-size:0.95rem;}.chat-proactive-prompt span{font-size:0.85rem;opacity:0.9;}.chat-proactive-prompt.prompt-close{position:absolute;top:0.25rem;right:0.5rem;background:none;border:none;color:rgba(255,255,255,0.7);font-size:1.2rem;cursor:pointer;padding:0;line-height:1;}.chat-proactive-prompt.prompt-close:hover{color:white;}`;document.head.appendChild(styleSheet);}
chatContainer.appendChild(promptBubble);hasShownProactivePrompt=true;sessionStorage.setItem('chatPromptShown','true');promptBubble.addEventListener('click',(e)=>{if(!e.target.classList.contains('prompt-close')){promptBubble.remove();if(!isOpen)toggleChat();}});const closeBtn=promptBubble.querySelector('.prompt-close');closeBtn.addEventListener('click',(e)=>{e.stopPropagation();promptBubble.remove();});setTimeout(()=>{if(promptBubble.parentElement){promptBubble.style.animation='promptSlideIn 0.3s ease reverse';setTimeout(()=>promptBubble.remove(),300);}},15000);}
const toggleChat=(e)=>{if(hasMoved){hasMoved=false;return;}
isOpen=!isOpen;if(isOpen){chatWindow.classList.add('open');chatToggle.classList.add('active');chatInput.focus();if(chatFloatingCtas){chatFloatingCtas.classList.remove('visible');ctasVisible=false;}
if(chatMessages.children.length===0){addWelcomeMessage();}}else{chatWindow.classList.remove('open');chatToggle.classList.remove('active');}};const startDrag=(e)=>{if(e.target.closest('.chat-close')||e.target.closest('#chat-input')||e.target.closest('.chat-send')||e.target.classList.contains('resize-handle')){return;}
isDragging=true;hasMoved=false;dragStartX=e.clientX;dragStartY=e.clientY;const rect=chatContainer.getBoundingClientRect();dragOffsetX=e.clientX-rect.left;dragOffsetY=e.clientY-rect.top;if(chatHeader.style)chatHeader.style.cursor='grabbing';e.preventDefault();};const drag=(e)=>{if(!isDragging)return;const moveDistance=Math.abs(e.clientX-dragStartX)+Math.abs(e.clientY-dragStartY);if(moveDistance>5){hasMoved=true;}
e.preventDefault();const newLeft=e.clientX-dragOffsetX;const newTop=e.clientY-dragOffsetY;chatContainer.style.position='fixed';chatContainer.style.left=`${newLeft}px`;chatContainer.style.top=`${newTop}px`;chatContainer.style.right='auto';chatContainer.style.bottom='auto';};const stopDrag=(e)=>{if(isDragging){isDragging=false;if(chatHeader.style)chatHeader.style.cursor='move';}};const startResize=(e,direction)=>{isResizing=true;resizeDirection=direction;resizeStartX=e.clientX;resizeStartY=e.clientY;const rect=chatWindow.getBoundingClientRect();const currentStyle=window.getComputedStyle(chatWindow);const containerStyle=window.getComputedStyle(chatContainer);resizeStartWidth=rect.width;resizeStartHeight=rect.height;const usingFixedPosition=containerStyle.position==='fixed'&&containerStyle.left!=='auto';if(usingFixedPosition){resizeStartLeft=parseInt(containerStyle.left)||0;resizeStartTop=parseInt(containerStyle.top)||0;}else{resizeStartRight=parseInt(currentStyle.right)||0;resizeStartBottom=parseInt(currentStyle.bottom)||120;}
e.preventDefault();e.stopPropagation();};const resize=(e)=>{if(!isResizing)return;e.preventDefault();const deltaX=e.clientX-resizeStartX;const deltaY=e.clientY-resizeStartY;let newWidth=resizeStartWidth;let newHeight=resizeStartHeight;const containerStyle=window.getComputedStyle(chatContainer);const usingFixedPosition=containerStyle.position==='fixed'&&containerStyle.left!=='auto';let maxAllowedHeight=getMaxHeight();if(usingFixedPosition){const currentTop=parseInt(containerStyle.top)||0;maxAllowedHeight=Math.min(maxAllowedHeight,window.innerHeight-currentTop-20);}
if(resizeDirection.includes('e')){newWidth=resizeStartWidth+deltaX;}else if(resizeDirection.includes('w')){newWidth=resizeStartWidth-deltaX;if(usingFixedPosition){const widthDiff=Math.max(MIN_WIDTH,Math.min(MAX_WIDTH,newWidth))-resizeStartWidth;const newLeft=resizeStartLeft-widthDiff;chatContainer.style.left=`${Math.max(0,newLeft)}px`;}else{const widthDiff=Math.max(MIN_WIDTH,Math.min(MAX_WIDTH,newWidth))-resizeStartWidth;chatWindow.style.right=`${resizeStartRight-widthDiff}px`;}}
if(resizeDirection.includes('s')){newHeight=resizeStartHeight+deltaY;}else if(resizeDirection.includes('n')){newHeight=resizeStartHeight-deltaY;if(usingFixedPosition){const heightDiff=Math.max(MIN_HEIGHT,Math.min(maxAllowedHeight,newHeight))-resizeStartHeight;const newTop=resizeStartTop-heightDiff;chatContainer.style.top=`${Math.max(0,newTop)}px`;}else{const heightDiff=Math.max(MIN_HEIGHT,Math.min(maxAllowedHeight,newHeight))-resizeStartHeight;chatWindow.style.bottom=`${resizeStartBottom-heightDiff}px`;}}
const constrainedWidth=Math.max(MIN_WIDTH,Math.min(MAX_WIDTH,newWidth));const constrainedHeight=Math.max(MIN_HEIGHT,Math.min(maxAllowedHeight,newHeight));chatWindow.style.width=`${constrainedWidth}px`;chatWindow.style.height=`${constrainedHeight}px`;};const stopResize=()=>{if(isResizing){isResizing=false;resizeDirection=null;}};const addWelcomeMessage=()=>{addMessage('Hello! Welcome to TECHGURU. I\'m here to help you discover how automation and AI can streamline your operations and enhance your digital presence. How can I assist you today?','assistant');};const showLeadCapturePrompt=()=>{if(hasOfferedLeadCapture)return;hasOfferedLeadCapture=true;const leadCaptureDiv=document.createElement('div');leadCaptureDiv.className='chat-lead-capture';leadCaptureDiv.innerHTML=`<p>Would you like to continue this conversation?</p><a href="https://cal.com/techguru/strategy-call"target="_blank"rel="noopener"class="lead-cta-btn primary">Schedule Free Strategy Call</a><button class="lead-cta-btn secondary"id="lead-email-btn">Get Resources via Email</button>`;chatMessages.appendChild(leadCaptureDiv);chatMessages.scrollTop=chatMessages.scrollHeight;const emailBtn=document.getElementById('lead-email-btn');if(emailBtn){emailBtn.addEventListener('click',()=>{showEmailCapture(leadCaptureDiv);});}};const showEmailCapture=(parentDiv)=>{parentDiv.innerHTML=`<form id="chat-email-form"class="chat-email-form"><label for="chat-email-input">Enter your email for resources:</label><div class="email-input-row"><input type="email"id="chat-email-input"placeholder="your@email.com"required><button type="submit">Send</button></div></form>`;const emailForm=document.getElementById('chat-email-form');emailForm.addEventListener('submit',async(e)=>{e.preventDefault();const emailInput=document.getElementById('chat-email-input');const email=emailInput.value.trim();if(!email)return;try{const res=await fetch('/api/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,source:'chat-widget'})});if(res.ok){parentDiv.innerHTML=`<p class="lead-success">Thanks!Check your inbox for the AI Automation Starter Kit.</p>`;}else{parentDiv.innerHTML=`<p class="lead-error">Something went wrong.Please try again.</p>`;}}catch(err){parentDiv.innerHTML=`<p class="lead-error">Connection error.Please try again.</p>`;}});};const formatTime=()=>{const now=new Date();return now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});};const copyToClipboard=async(text,button)=>{try{await navigator.clipboard.writeText(text);button.classList.add('copied');button.innerHTML='âœ“';setTimeout(()=>{button.classList.remove('copied');button.innerHTML='ðŸ“‹';},2000);}catch(err){console.error('Failed to copy:',err);}};const handleReaction=(button,type)=>{const allReactions=button.parentElement.querySelectorAll('.reaction-btn');allReactions.forEach(btn=>btn.classList.remove('active'));button.classList.add('active');console.log(`Reaction:${type}`);};const addMessage=(content,role)=>{const messageDiv=document.createElement('div');messageDiv.className=`chat-message ${role}`;const avatar=document.createElement('div');avatar.className=`message-avatar`;if(role==='user'){avatar.textContent='You';}else{const logoImg=document.createElement('img');logoImg.src='images/icons/nav-icon-new.webp';logoImg.alt='TECHGURU';avatar.appendChild(logoImg);}
const contentWrapper=document.createElement('div');contentWrapper.className='message-content';const bubble=document.createElement('div');bubble.className='message-bubble';bubble.textContent=content;const timestamp=document.createElement('span');timestamp.className='message-time';timestamp.textContent=formatTime();contentWrapper.appendChild(bubble);contentWrapper.appendChild(timestamp);if(role==='assistant'){const actionsDiv=document.createElement('div');actionsDiv.className='message-reactions';const thumbsUp=document.createElement('button');thumbsUp.className='reaction-btn';thumbsUp.innerHTML='ðŸ‘';thumbsUp.title='Helpful';thumbsUp.addEventListener('click',()=>handleReaction(thumbsUp,'helpful'));const thumbsDown=document.createElement('button');thumbsDown.className='reaction-btn';thumbsDown.innerHTML='ðŸ‘Ž';thumbsDown.title='Not helpful';thumbsDown.addEventListener('click',()=>handleReaction(thumbsDown,'not-helpful'));const copyBtn=document.createElement('button');copyBtn.className='copy-btn';copyBtn.innerHTML='ðŸ“‹';copyBtn.title='Copy message';copyBtn.addEventListener('click',()=>copyToClipboard(content,copyBtn));actionsDiv.appendChild(thumbsUp);actionsDiv.appendChild(thumbsDown);actionsDiv.appendChild(copyBtn);contentWrapper.appendChild(actionsDiv);}
messageDiv.appendChild(avatar);messageDiv.appendChild(contentWrapper);chatMessages.appendChild(messageDiv);chatMessages.scrollTop=chatMessages.scrollHeight;};const addLoadingMessage=()=>{const messageDiv=document.createElement('div');messageDiv.className='chat-message loading assistant';messageDiv.id='loading-message';const avatar=document.createElement('div');avatar.className='chat-message-avatar assistant-avatar';const logoImg=document.createElement('img');logoImg.src='images/icons/nav-icon-new.webp';logoImg.alt='TECHGURU';avatar.appendChild(logoImg);const contentDiv=document.createElement('div');contentDiv.className='chat-message-content';contentDiv.innerHTML='<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';messageDiv.appendChild(avatar);messageDiv.appendChild(contentDiv);chatMessages.appendChild(messageDiv);chatMessages.scrollTop=chatMessages.scrollHeight;};const removeLoadingMessage=()=>{const loadingMessage=document.getElementById('loading-message');if(loadingMessage){loadingMessage.remove();}};const sendMessage=async(event)=>{event.preventDefault();const message=chatInput.value.trim();if(!message)return;if(isLoading)return;addMessage(message,'user');chatInput.value='';isLoading=true;if(chatSendBtn)chatSendBtn.classList.add('sending');addLoadingMessage();try{const response=await fetch(API_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({message}),});removeLoadingMessage();if(!response.ok){const errorData=await response.json().catch(()=>({}));const errorMessage=errorData.error||`Error:${response.status}${response.statusText}`;addMessage(`Sorry,I encountered an error:${errorMessage}`,'assistant');isLoading=false;if(chatSendBtn)chatSendBtn.classList.remove('sending');return;}
const data=await response.json();const reply=data.reply||'No response received';addMessage(reply,'assistant');messageCount++;if(messageCount>=4&&!hasOfferedLeadCapture){setTimeout(showLeadCapturePrompt,1500);}}catch(error){removeLoadingMessage();console.error('Chat API Error:',error);addMessage('Sorry, I couldn\'t connect to the service. Please try again later.','assistant');}finally{isLoading=false;if(chatSendBtn)chatSendBtn.classList.remove('sending');chatInput.focus();}};chatToggle.addEventListener('click',toggleChat);chatClose.addEventListener('click',toggleChat);chatForm.addEventListener('submit',sendMessage);if(chatClear){chatClear.addEventListener('click',()=>{chatMessages.innerHTML='';messageCount=0;hasOfferedLeadCapture=false;uploadedFiles=[];if(chatSuggestions){chatSuggestions.style.display='flex';}
if(chatFilePreview){chatFilePreview.innerHTML='';}
addMessage("Hi! I'm the TechGuru AI assistant. How can I help you today?",'assistant');});}
if(chatSuggestions){const suggestionChips=chatSuggestions.querySelectorAll('.suggestion-chip');suggestionChips.forEach(chip=>{chip.addEventListener('click',async(e)=>{e.preventDefault();const message=chip.getAttribute('data-message');if(message&&!isLoading){chatInput.value=message;chatSuggestions.style.display='none';const submitEvent=new Event('submit',{bubbles:true,cancelable:true});chatForm.dispatchEvent(submitEvent);}});});}
chatToggle.addEventListener('mousedown',startDrag);chatHeader.addEventListener('mousedown',startDrag);document.addEventListener('mousemove',(e)=>{drag(e);resize(e);});document.addEventListener('mouseup',(e)=>{stopDrag(e);stopResize();});const resizeHandles=document.querySelectorAll('.resize-handle');resizeHandles.forEach(handle=>{const direction=handle.className.split(' ')[1].replace('resize-handle-','');handle.addEventListener('mousedown',(e)=>startResize(e,direction));});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&isOpen){toggleChat();}});chatInput.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&isLoading){e.preventDefault();}});if(chatCharCount){chatInput.addEventListener('input',()=>{const currentLength=chatInput.value.length;chatCharCount.textContent=`${currentLength}/${MAX_CHARS}`;if(currentLength>=MAX_CHARS*0.9){chatCharCount.classList.add('warning');}else{chatCharCount.classList.remove('warning');}
if(currentLength>MAX_CHARS){chatInput.value=chatInput.value.substring(0,MAX_CHARS);chatCharCount.textContent=`${MAX_CHARS}/${MAX_CHARS}`;}});}
window.addEventListener('resize',()=>{const maxAllowedHeight=getMaxHeight();const computedHeight=chatWindow.getBoundingClientRect().height;if(computedHeight>maxAllowedHeight){chatWindow.style.height=`${maxAllowedHeight}px`;}});const initMaxHeight=getMaxHeight();const initialHeight=chatWindow.getBoundingClientRect().height;if(initialHeight>initMaxHeight){chatWindow.style.height=`${initMaxHeight}px`;}});